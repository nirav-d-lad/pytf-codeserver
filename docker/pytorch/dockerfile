FROM python:3.12-bookworm

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TF_FORCE_GPU_ALLOW_GROWTH=true

# System packages (Box2D + common DS tooling)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    build-essential \
    swig \
    ffmpeg \
    libgl1 \
    libglib2.0-0 \
    libxrender1 \
    libsm6 \
    libxext6 \
    && rm -rf /var/lib/apt/lists/*

# Install code-server (VS Code in the browser)
RUN curl -fsSL https://code-server.dev/install.sh | sh

WORKDIR /workspace

# Python deps (install into the conda python in this base image)
COPY pytorch/requirements.txt .
RUN python -m pip install --upgrade pip setuptools wheel \
 && python -m pip install --no-cache-dir -r requirements.txt \
 && rm -f requirements.txt

# --- code-server config files ---
# extensions to install
COPY codeserver/extensions.txt /tmp/extensions.txt
# user settings
COPY codeserver/settings.json /root/.local/share/code-server/User/settings.json
# workspace recommendations
COPY codeserver/extensions.json /workspace/.vscode/extensions.json

RUN set -eux; \
    mkdir -p /root/.local/share/code-server/User /workspace/.vscode; \
    while IFS= read -r ext || [ -n "$ext" ]; do \
      ext="$(printf '%s' "$ext" | tr -d '\r')"; \
      [ -z "$ext" ] && continue; \
      case "$ext" in \#*) continue ;; esac; \
      echo "Installing: $ext"; \
      code-server --install-extension "$ext" || true; \
    done < /tmp/extensions.txt; \
    rm -f /tmp/extensions.txt


EXPOSE 8080
CMD ["code-server", "--bind-addr", "0.0.0.0:8080", "--auth", "none", "/workspace"]
